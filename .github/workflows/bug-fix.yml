# 在 GitHub 仓库中给一个问题（Issue）打上"bug"标签时，
# 会自动启动 Claude AI 来分析代码、修复错误并提交代码拉取请求（PR）。
name: Claude Bug Fix Automation

on:
  issues:
    types: [labeled]

jobs:
  auto-fix-bug:
    # Only run when issue is labeled with 'bug'
    if: github.event.label.name == 'bug'
    runs-on: ubuntu-latest
    permissions:
      contents: write # To create branches and commits
      pull-requests: write # To create PRs
      issues: write # To comment on issues
      id-token: write
      actions: read

    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude to fix the bug
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}

            Your task is to automatically fix the bug described in the issue above.

            IMPORTANT: Follow the repository conventions defined in CLAUDE.md, including:
            - Python naming conventions (camelCase for internal, snake_case for API contracts)
            - Security best practices
            - Testing requirements

            Steps:
            1. Read and analyze the issue to understand what needs to be fixed
            2. Read CLAUDE.md for repository-specific guidelines
            3. Locate and read the affected files
            4. Fix ALL bugs and security issues you identify
            5. Run any relevant tests to verify the fix
            6. Commit your changes with a clear commit message following the repo style
            7. Create a pull request with a detailed description
            8. Comment on the original issue with a summary and PR link
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 10
            --allowed-tools "Read,Edit,Write,Glob,Grep,Bash(git:*),Bash(npm:*),Bash(npx:*),Bash(gh:*),Bash(pytest:*),Bash(python:*)"
